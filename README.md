# Kubernetes - LDAP authentication with Dex Updated as on 2021 30th JAN

* [Docs](#docs)
* [Requirements](#requirements)
* [Login application](#login-application)
* [Dex](#dex)
  * [CRD](#crd)
  * [Deployment](#deployment)
* [Test](#test)

## Docs

This deployment follows Dex by CoreOS & Kubernetes Documentations:

* [Kubernetes OIDC Doc](https://kubernetes.io/docs/admin/authentication/#option-1---oidc-authenticator)
* [Dex by CoreOS](https://github.com/coreos/dex)
* [Login App](https://github.com/Flav35/loginapp)

## Requirements

I have used Virtualbox having:
k8s 1 node cluster bootstrapped thru  kubeadm (kube-api-server running as POD) 
dex (running as pod)
loginapp (running as POD)
ldap server(running as standalone application not under POD)

OS: Ubuntu 20 (CPU: 2 cores RAM:4G disk: 40G)
go version go1.15.7 linux/amd64
Docker Community Version: 20.10.2

k8s: Server Version: version.Info{Major:"1", Minor:"20", GitVersion:"v1.20.2", GitCommit:"faecb196815e248d3ecfb03c680a4507229c2a56", GitTreeState:"clean", BuildDate:"2021-01-13T13:20:00Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"}

* DNS entries: (Since this configuration uses NodePort, these can be CNAMEs to your kubernetes nodes)
  for DNS entries pointing to loginapp,dex,ldap you can edit coredns configmap add following entries

   hosts custom.hosts example.org {
      10.0.2.15 ldap.k8s.example.org dex.example.org login.k8s.example.org
      fallthrough
    }
   
  * **dex.k8s.example.org** --> Dex OIDC provider
  * **login.k8s.example.org** --> Custom Login Application

I tried 

* Kubernetes cluster available with the following requirements:
  * RBAC enabled
  * OIDC authentication enabled. API server configuration:
    * **--oidc-issuer-url=https://dex.k8s.example.com/dex**: External Dex endpoint
    * **--oidc-client-id=loginapp**: ID for our Login Application
    * **--oidc-ca-file=/etc/kubernetes/ssl/ca.pem**: CA file generated using gencert.sh below
    * **--oidc-username-claim=name**: Map to **nameAttr** Dex configuration. This will be used by Kubernetes RBAC to authorize users based on their name.
    * **oidc-groups-claim=groups**: This will be used by Kubernetes RBAC to authorize users based on their groups.

* An available LDAP server

## Login application

* Create the auth namespace:

```shell
kubectl create ns auth
```

* Create required SSL certs and secrets (make sure to update alt_names to match your domain)

```shell
./gencert.sh
kubectl create secret tls login.k8s.example.org.tls --cert=ssl/cert.pem --key=ssl/key.pem -n auth
kubectl create secret tls dex.k8s-dev.truecaller.net.tls --cert=ssl/cert.pem --key=ssl/key.pem -n auth
```

* Create resources:

```shell
# CA ( ca.pem generated by gencert.sh) configmap
kubectl create -f ca-cm.yml
# Login App configuration
kubectl create -f loginapp-cm.yml
# Login App service
kubectl create -f loginapp-ing-svc.yml
# Login App Deployment
kubectl create -f loginapp-deploy.yml
```

loginapp pod status will be completed  but wont be able to serve anything
because Dex is not deployed.

## Dex

### CRD

We will use Kubernetes Custom Resource Definitions (https://kubernetes.io/docs/concepts/api-extension/custom-resources/) as Dex storage backend.

```shell
kubectl create -f dex-crd.yml
```

### Deployment

* Create Dex resources:

```shell
# Dex configuration
kubectl create -f dex-cm.yml
# Dex service
kubectl create -f dex-ing-svc.yml
# Dex deployment
kubectl create -f dex-deploy.yml
```

try https://login.k8s.example.org:32002, login and retrieve k8s configuration.
decode your token thru https://jwt.io

* Create RBAC resource (assgin a group called "admins" cluster admin role):

```shell
kubectl create -f rbac.yml
```

Now copy paste the  Full kubeconfig file from loginapp Web UI to your ~/.kube/config on shell account

```shell
root@sudik8s:~/k8s-ldap# kubectl get po -n auth
NAME                        READY   STATUS    RESTARTS   AGE
dex-c47dfcb45-6f8c2         1/1     Running   0          22m
loginapp-6749dd76f4-z2vwl   1/1     Running   0          22m
```
